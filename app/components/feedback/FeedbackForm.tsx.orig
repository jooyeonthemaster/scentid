"use client";

import React, { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Chart as ChartJS,
  RadialLinearScale,
  PointElement,
  LineElement,
  Filler,
  Tooltip,
  Legend,
  ArcElement
} from 'chart.js';
import { Radar, Doughnut } from 'react-chartjs-2';
import { 
  PerfumeCategory, 
  CategoryPreference, 
  PerfumeFeedback, 
  SpecificScent,
  FragranceCharacteristic,
  CharacteristicValue,
  UserFriendlyCharacteristics,
  CustomPerfumeRecipe,
  TestGuide,
  RecipeComponent
} from '@/app/types/perfume';
import { perfumes } from '@/app/data/perfumeData';

// Chart.js ë“±ë¡
ChartJS.register(
  RadialLinearScale,
  PointElement,
  LineElement,
  Filler,
  Tooltip,
  Legend,
  ArcElement
);

interface FeedbackFormProps {
  perfumeId: string;
  perfumeName: string; // í–¥ìˆ˜ ì´ë¦„ ì¶”ê°€
  onClose: () => void;
  onSubmit: () => void;
}

// ì´ˆê¸° í”¼ë“œë°± ë°ì´í„°
const INITIAL_FEEDBACK_DATA: PerfumeFeedback = {
  perfumeId: '',
  impression: '',
  retentionPercentage: 50, // ê¸°ë³¸ê°’ 50%ë¡œ ë³€ê²½
  categoryPreferences: {
    citrus: 'maintain',
    floral: 'maintain',
    woody: 'maintain',
    musky: 'maintain', 
    fruity: 'maintain',
    spicy: 'maintain'
  },
  userCharacteristics: {
    weight: 'medium',
    sweetness: 'medium',
    freshness: 'medium',
    uniqueness: 'medium'
  },
  specificScents: [],
  notes: '',
};

// ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë§¤í•‘
const CATEGORY_NAMES: Record<PerfumeCategory, string> = {
  citrus: 'ìƒí¼í•œ í–¥',
  floral: 'ê½ƒ í–¥ê¸°',
  woody: 'ë‚˜ë¬´/ìì—° í–¥',
  musky: 'í¬ê·¼í•œ í–¥',
  fruity: 'ê³¼ì¼ í–¥',
  spicy: 'ìê·¹ì ì¸ í–¥'
};

// ì¹´í…Œê³ ë¦¬ ì•„ì´ì½˜ ë§¤í•‘
const CATEGORY_ICONS: Record<PerfumeCategory, string> = {
  citrus: 'ğŸ‹',
  floral: 'ğŸŒ¸',
  woody: 'ğŸŒ³',
  musky: 'ğŸ§´',
  fruity: 'ğŸ',
  spicy: 'ğŸŒ¶ï¸'
};

// í–¥ìˆ˜ ê³„ì—´ ì„¤ëª… ì¶”ê°€
const CATEGORY_DESCRIPTIONS: Record<PerfumeCategory, string> = {
  citrus: 'ë ˆëª¬, ì˜¤ë Œì§€ ê°™ì€ ìƒí¼í•˜ê³  ì‹œì›í•œ í–¥ê¸°',
  floral: 'ì¥ë¯¸, ììŠ¤ë¯¼ ê°™ì€ ê½ƒì˜ ë‹¬ì½¤í•˜ê³  ë¶€ë“œëŸ¬ìš´ í–¥ê¸°',
  woody: 'ë‚˜ë¬´, í™, ì´ë¼ ê°™ì€ ìì—°ì ì´ê³  í¸ì•ˆí•œ í–¥ê¸°',
  musky: 'ë”°ëœ»í•˜ê³  ì•ˆì •ê°ì„ ì£¼ëŠ” í¬ê·¼í•œ í–¥ê¸°',
  fruity: 'ë”¸ê¸°, ë³µìˆ­ì•„ ê°™ì€ ë‹¬ì½¤í•˜ê³  ìƒí¼í•œ ê³¼ì¼ í–¥ê¸°',
  spicy: 'í›„ì¶”, ê³„í”¼ ê°™ì€ ê°•ë ¬í•˜ê³  ìê·¹ì ì¸ í–¥ê¸°'
};

// í–¥ë£Œ ì˜ˆì‹œ ì¶”ê°€
const CATEGORY_EXAMPLES: Record<PerfumeCategory, string> = {
  citrus: 'ë ˆëª¬, ë² ë¥´ê°€ëª», ê·¸ë ˆì´í”„í”„ë£¨íŠ¸',
  floral: 'ì¥ë¯¸, ììŠ¤ë¯¼, ë¼ë²¤ë”, íŠ¤ë¦½',
  woody: 'ìƒŒë‹¬ìš°ë“œ, ì‹œë”ìš°ë“œ, ë² í‹°ë²„',
  musky: 'ë¨¸ìŠ¤í¬, ì•°ë²„, ë°”ë‹ë¼',
  fruity: 'ë”¸ê¸°, ë³µìˆ­ì•„, ë¸”ë™ë² ë¦¬, ì‚¬ê³¼',
  spicy: 'í•‘í¬í˜í¼, ì‹œë‚˜ëª¬, ë„›ë©”ê·¸'
};

// ì„ í˜¸ë„ í…ìŠ¤íŠ¸ ë§¤í•‘
const PREFERENCE_TEXT: Record<CategoryPreference, string> = {
  increase: 'ë” ê°•í•˜ê²Œ',
  decrease: 'ë” ì•½í•˜ê²Œ',
  maintain: 'í˜„ì¬ ìœ ì§€'
};

// í–¥ íŠ¹ì„± ì´ë¦„ ë§¤í•‘
const CHARACTERISTIC_NAMES: Record<FragranceCharacteristic, string> = {
  weight: 'ë¬´ê²Œê°',
  sweetness: 'ë‹¹ë„',
  freshness: 'ì²­ëŸ‰ê°',
  uniqueness: 'ê°œì„±'
};

// í–¥ íŠ¹ì„± ì„¤ëª… ë§¤í•‘
const CHARACTERISTIC_DESCRIPTIONS: Record<FragranceCharacteristic, string> = {
  weight: 'í–¥ì´ ì–¼ë§ˆë‚˜ ë¬´ê²ê±°ë‚˜ ê°€ë²¼ìš´ì§€ - ê°€ë³ê²Œ ë³€ê²½í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”, ë¬´ê²ê²Œ ë³€ê²½í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?',
  sweetness: 'í–¥ì´ ì–¼ë§ˆë‚˜ ë‹¬ì½¤í•œì§€ - ëœ ë‹¬ì½¤í•˜ê²Œ ë³€ê²½í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”, ë” ë‹¬ì½¤í•˜ê²Œ ë³€ê²½í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?',
  freshness: 'í–¥ì´ ì–¼ë§ˆë‚˜ ìƒì¾Œí•˜ê³  ì‹œì›í•œì§€ - ë” ë”°ëœ»í•˜ê²Œ ë³€ê²½í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”, ë” ì‹œì›í•˜ê²Œ ë³€ê²½í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?',
  uniqueness: 'í–¥ì´ ì–¼ë§ˆë‚˜ ë…íŠ¹í•˜ê³  íŠ¹ë³„í•œì§€ - ë” ë¬´ë‚œí•˜ê²Œ ë³€ê²½í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”, ë” ë…íŠ¹í•˜ê²Œ ë³€ê²½í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?'
};

// í–¥ íŠ¹ì„± ë‹¨ê³„ë³„ ë ˆì´ë¸”
const CHARACTERISTIC_LABELS: Record<FragranceCharacteristic, Record<CharacteristicValue, string>> = {
  weight: {
    veryLow: 'í›¨ì”¬ ë” ê°€ë³ê²Œ',
    low: 'ë” ê°€ë³ê²Œ',
    medium: 'í˜„ì¬ ë¬´ê²Œê° ìœ ì§€',
    high: 'ë” ë¬´ê²ê²Œ',
    veryHigh: 'í›¨ì”¬ ë” ë¬´ê²ê²Œ'
  },
  sweetness: {
    veryLow: 'í›¨ì”¬ ëœ ë‹¬ì½¤í•˜ê²Œ',
    low: 'ëœ ë‹¬ì½¤í•˜ê²Œ',
    medium: 'í˜„ì¬ ë‹¹ë„ ìœ ì§€',
    high: 'ë” ë‹¬ì½¤í•˜ê²Œ',
    veryHigh: 'í›¨ì”¬ ë” ë‹¬ì½¤í•˜ê²Œ'
  },
  freshness: {
    veryLow: 'í›¨ì”¬ ë” ë”°ëœ»í•˜ê²Œ',
    low: 'ë” ë”°ëœ»í•˜ê²Œ',
    medium: 'í˜„ì¬ ì²­ëŸ‰ê° ìœ ì§€',
    high: 'ë” ì‹œì›í•˜ê²Œ',
    veryHigh: 'í›¨ì”¬ ë” ì‹œì›í•˜ê²Œ'
  },
  uniqueness: {
    veryLow: 'í›¨ì”¬ ë” ë¬´ë‚œí•˜ê²Œ',
    low: 'ë” ë¬´ë‚œí•˜ê²Œ',
    medium: 'í˜„ì¬ ê°œì„± ìœ ì§€',
    high: 'ë” ë…íŠ¹í•˜ê²Œ',
    veryHigh: 'í›¨ì”¬ ë” ë…íŠ¹í•˜ê²Œ'
  }
};

// íŠ¹ì„±ê°’ì„ ìŠ¬ë¼ì´ë” ê°’ìœ¼ë¡œ ë³€í™˜
const characteristicToSliderValue = (value: CharacteristicValue): number => {
  switch(value) {
    case 'veryLow': return 1;
    case 'low': return 2;
    case 'medium': return 3;
    case 'high': return 4;
    case 'veryHigh': return 5;
    default: return 3;
  }
};

// ìŠ¬ë¼ì´ë” ê°’ì„ íŠ¹ì„±ê°’ìœ¼ë¡œ ë³€í™˜
const sliderToCharacteristicValue = (value: number): CharacteristicValue => {
  switch(value) {
    case 1: return 'veryLow';
    case 2: return 'low';
    case 3: return 'medium';
    case 4: return 'high';
    case 5: return 'veryHigh';
    default: return 'medium';
  }
};

// í–¥ë£Œ IDë¥¼ ì½”ë“œ í˜•ì‹(MS-XXXXXXX)ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ ì¶”ê°€
const formatScentCode = (id: string): string => {
  // ê¸°ì¡´ IDì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
  const numericPart = id.replace(/\D/g, '');
  // ìˆ«ìê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìˆ«ì ì‚¬ìš©
  const paddedNumericPart = numericPart ? numericPart.padStart(7, '0') : (Math.floor(Math.random() * 10000000)).toString().padStart(7, '0');
  // MS- ì ‘ë‘ì‚¬ ì¶”ê°€
  return `MS-${paddedNumericPart}`;
};

export default function FeedbackForm({ perfumeId, perfumeName, onClose, onSubmit }: FeedbackFormProps) {
  const [step, setStep] = useState(1);
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [feedback, setFeedback] = useState<PerfumeFeedback>({
    ...INITIAL_FEEDBACK_DATA,
    perfumeId,
  });
  const [selectedScent, setSelectedScent] = useState<SpecificScent | null>(null);
  const [selectedCategory, setSelectedCategory] = useState<PerfumeCategory>('citrus');
  const [scentSearchTerm, setScentSearchTerm] = useState('');
  const [activeCharacteristic, setActiveCharacteristic] = useState<FragranceCharacteristic>('weight');
  const [recipe, setRecipe] = useState<CustomPerfumeRecipe | null>(null);
  const [customizationLoading, setCustomizationLoading] = useState(false);

  // perfumeData.tsì—ì„œ í–¥ë£Œ ë°ì´í„° ì¶”ì¶œ
  const generateAvailableScents = () => {
    const scentsMap = new Map();
    
    // ëª¨ë“  í–¥ìˆ˜ì—ì„œ í–¥ë£Œ ì •ë³´ ì¶”ì¶œ
    perfumes.forEach(perfume => {
      // ë©”ì¸ í–¥ë£Œ
      if (perfume.mainScent && perfume.mainScent.name) {
        const id = perfume.id;
        const name = perfume.mainScent.name;
        const key = `${id}`;  // í–¥ìˆ˜ IDë¥¼ ê·¸ëŒ€ë¡œ í‚¤ë¡œ ì‚¬ìš©
        
        if (!scentsMap.has(key)) {
          scentsMap.set(key, {
            id: id,
            name: name,
            category: perfume.category,
            description: perfume.mainScent.description || `${name}ì˜ íŠ¹ì§•ì ì¸ í–¥`
          });
        }
      }
      
      // ì„œë¸Œ í–¥ë£Œ 1
      if (perfume.subScent1 && perfume.subScent1.name) {
        const id = `${perfume.id}-1`;  // ê³ ìœ í•œ ID ìƒì„±
        const name = perfume.subScent1.name;
        const key = `${id}`;
        
        if (!scentsMap.has(key)) {
          scentsMap.set(key, {
            id: id,
            name: name,
            category: determineCategory(name),
            description: perfume.subScent1.description || `${name}ì˜ íŠ¹ì§•ì ì¸ í–¥`
          });
        }
      }
      
      // ì„œë¸Œ í–¥ë£Œ 2
      if (perfume.subScent2 && perfume.subScent2.name) {
        const id = `${perfume.id}-2`;  // ê³ ìœ í•œ ID ìƒì„±
        const name = perfume.subScent2.name;
        const key = `${id}`;
        
        if (!scentsMap.has(key)) {
          scentsMap.set(key, {
            id: id,
            name: name,
            category: determineCategory(name),
            description: perfume.subScent2.description || `${name}ì˜ íŠ¹ì§•ì ì¸ í–¥`
          });
        }
      }
    });
    
    return Array.from(scentsMap.values());
  };
  
  // í–¥ë£Œ ì´ë¦„ì— ë”°ë¼ ì¹´í…Œê³ ë¦¬ ì¶”ì •
  const determineCategory = (name: string): PerfumeCategory => {
    name = name.toLowerCase();
    if (name.includes('ì‹œíŠ¸ëŸ¬ìŠ¤') || name.includes('ë ˆëª¬') || name.includes('ì˜¤ë Œì§€') || name.includes('ìëª½') || name.includes('ë¼ì„') || name.includes('ë² ë¥´ê°€ëª»')) {
      return 'citrus';
    }
    if (name.includes('ì¥ë¯¸') || name.includes('ììŠ¤ë¯¼') || name.includes('íŠ¤ë¦½') || name.includes('í”Œë¡œëŸ´') || name.includes('ê½ƒ')) {
      return 'floral';
    }
    if (name.includes('ìš°ë””') || name.includes('ë‚˜ë¬´') || name.includes('ìƒŒë‹¬') || name.includes('ì‹œë”') || name.includes('íŒŒì¸')) {
      return 'woody';
    }
    if (name.includes('ë¨¸ìŠ¤í¬') || name.includes('ì•°ë²„') || name.includes('ë°”ë‹ë¼')) {
      return 'musky';
    }
    if (name.includes('ë² ë¦¬') || name.includes('ê³¼ì¼') || name.includes('ì‚¬ê³¼') || name.includes('ë³µìˆ­ì•„') || name.includes('ë”¸ê¸°')) {
      return 'fruity';
    }
    if (name.includes('ìŠ¤íŒŒì´ì‹œ') || name.includes('ì‹œë‚˜ëª¬') || name.includes('í›„ì¶”') || name.includes('í˜í¼')) {
      return 'spicy';
    }
    
    // í™•ì‹¤í•˜ì§€ ì•Šì€ ê²½ìš° ì›Œë”©ì´ë‚˜ íŠ¹ì„±ì— ë”°ë¼ ì¹´í…Œê³ ë¦¬ ë°°ì •
    if (name.includes('ë‹¬ì½¤') || name.includes('ìŠ¤ìœ„íŠ¸')) {
      return 'fruity';
    }
    if (name.includes('ìƒì¾Œ') || name.includes('ì‹ ì„ ')) {
      return 'citrus';
    }
    if (name.includes('ë”°ëœ»') || name.includes('í¬ê·¼')) {
      return 'musky';
    }
    if (name.includes('í—ˆë¸Œ') || name.includes('ë¯¼íŠ¸')) {
      return 'woody';
    }
    
    // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬
    return 'woody';
  };

  // ëª¨ë“  í–¥ë£Œ ëª©ë¡ ìƒì„±
  const availableScents = generateAvailableScents();

  // ì¸ìƒ ì´ëª¨í‹°ì½˜ ì˜µì…˜ - ì´ëª¨í‹°ì½˜ê³¼ ì„¤ëª…ì„ ë” ì§ê´€ì ìœ¼ë¡œ ìˆ˜ì •
  const impressionOptions = [
    { value: 'ğŸ˜', label: 'ì™„ë²½í•´ìš”', retention: 100 },
    { value: 'ğŸ˜Š', label: 'ì¢‹ì•„ìš”', retention: 80 },
    { value: 'ğŸ˜', label: 'ê´œì°®ì•„ìš”', retention: 60 },
    { value: 'ğŸ˜•', label: 'ì•„ì‰¬ì›Œìš”', retention: 40 },
    { value: 'ğŸ˜', label: 'ë³„ë¡œì˜ˆìš”', retention: 20 },
  ];

  // ì²«ì¸ìƒ ì„ íƒ ì‹œ ê¸°ë³¸ ìœ ì§€ ë¹„ìœ¨ ì„¤ì •
  useEffect(() => {
    if (feedback.impression) {
      const selectedOption = impressionOptions.find(option => option.value === feedback.impression);
      if (selectedOption) {
        setFeedback(prev => ({
          ...prev,
          retentionPercentage: selectedOption.retention
        }));
      }
    }
  }, [feedback.impression]);

  // í”¼ë“œë°± ì œì¶œ ì²˜ë¦¬
  const handleSubmit = async () => {
    try {
      setLoading(true);
      setError(null);

      // í–¥ì˜ ê°•ë„ë‚˜ ì§€ì†ë ¥ ê´€ë ¨ í”¼ë“œë°± ì œê±°
      const submissionData: PerfumeFeedback = {
        ...feedback,
        submittedAt: new Date().toISOString()
      };

      // specificScentsì—ì„œ ë¹ˆ í•­ëª© ì œê±°
      if (submissionData.specificScents?.length) {
        submissionData.specificScents = submissionData.specificScents.filter(
          scent => scent.id && scent.name && scent.ratio > 0
        );
      }

      // 1. ë¨¼ì € í”¼ë“œë°± ì œì¶œ
      const response = await fetch('/api/feedback', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(submissionData),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'í”¼ë“œë°± ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }

      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í”¼ë“œë°± ì €ì¥ (ì¤‘ë³µ ì œì¶œ ë°©ì§€)
      const storedFeedbacks = JSON.parse(localStorage.getItem('submittedFeedbacks') || '[]');
      localStorage.setItem('submittedFeedbacks', JSON.stringify([
        ...storedFeedbacks,
        { perfumeId, submittedAt: new Date().toISOString() },
      ]));

      setLoading(false);
      setSuccess(true);
      
      // 2. ì»¤ìŠ¤í„°ë§ˆì´ì œì´ì…˜ API í˜¸ì¶œ
      setCustomizationLoading(true);
      
      try {
        const customizeResponse = await fetch('/api/perfume/customize', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            feedback: submissionData
          }),
        });
        
        if (!customizeResponse.ok) {
          const errorData = await customizeResponse.json();
          console.error('ì»¤ìŠ¤í„°ë§ˆì´ì œì´ì…˜ API ì˜¤ë¥˜:', errorData);
          // API ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë”ë¼ë„ í”¼ë“œë°±ì€ ì œì¶œ ì™„ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ ì¹˜ëª…ì  ì˜¤ë¥˜ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
        } else {
          const customizeData = await customizeResponse.json();
          setRecipe(customizeData.recipe);
        }
      } catch (customizeErr) {
        console.error('ì»¤ìŠ¤í„°ë§ˆì´ì œì´ì…˜ API í˜¸ì¶œ ì˜¤ë¥˜:', customizeErr);
      } finally {
        setCustomizationLoading(false);
      }
      
      // ì»¤ìŠ¤í„°ë§ˆì´ì œì´ì…˜ ê²°ê³¼ê°€ í‘œì‹œë˜ë¯€ë¡œ ìë™ìœ¼ë¡œ ëª¨ë‹¬ì„ ë‹«ì§€ ì•ŠìŒ
    } catch (err) {
      setLoading(false);
      setCustomizationLoading(false);
      setError(err instanceof Error ? err.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error('í”¼ë“œë°± ì œì¶œ ì˜¤ë¥˜:', err);
    }
  };

  // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì»´í¬ë„ŒíŠ¸
  const CategorySelector = ({ category, currentValue, onChange }: { 
    category: PerfumeCategory, 
    currentValue: CategoryPreference, 
    onChange: (cat: PerfumeCategory, pref: CategoryPreference) => void 
  }) => {
    return (
      <div className="bg-white rounded-xl p-4 mb-4 shadow-sm border border-amber-100">
        <div className="flex items-center mb-2">
          <div className="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center mr-3 text-xl">
            {CATEGORY_ICONS[category]}
          </div>
          <div>
            <h3 className="font-medium text-gray-800">{CATEGORY_NAMES[category]}</h3>
            <p className="text-xs text-gray-500">{CATEGORY_DESCRIPTIONS[category]}</p>
          </div>
        </div>
        
        <div className="mt-2 mb-1">
          <p className="text-xs text-gray-600">
            <span className="font-medium">ì˜ˆì‹œ</span>: {CATEGORY_EXAMPLES[category]}
          </p>
        </div>
        
        <div className="flex justify-between border border-gray-200 rounded-lg overflow-hidden mt-3">
          <button 
            onClick={() => onChange(category, 'decrease')}
            className={`flex-1 py-2 px-1 text-sm transition-colors ${
              currentValue === 'decrease' 
                ? 'bg-red-100 text-red-700 font-medium' 
                : 'bg-gray-50 text-gray-700 hover:bg-gray-100'
            }`}
          >
            <div className="flex flex-col items-center">
              <span className="text-lg mb-1">ğŸ‘‡</span>
              <span className="text-xs">ë” ì•½í•˜ê²Œ</span>
            </div>
          </button>
          
          <button
            onClick={() => onChange(category, 'maintain')}
            className={`flex-1 py-2 px-1 text-sm transition-colors ${
              currentValue === 'maintain' 
                ? 'bg-amber-100 text-amber-700 font-medium' 
                : 'bg-gray-50 text-gray-700 hover:bg-gray-100'
            }`}
          >
            <div className="flex flex-col items-center">
              <span className="text-lg mb-1">ğŸ‘Œ</span>
              <span className="text-xs">í˜„ì¬ ìœ ì§€</span>
            </div>
          </button>
          
          <button 
            onClick={() => onChange(category, 'increase')}
            className={`flex-1 py-2 px-1 text-sm transition-colors ${
              currentValue === 'increase' 
                ? 'bg-green-100 text-green-700 font-medium' 
                : 'bg-gray-50 text-gray-700 hover:bg-gray-100'
            }`}
          >
            <div className="flex flex-col items-center">
              <span className="text-lg mb-1">ğŸ‘†</span>
              <span className="text-xs">ë” ê°•í•˜ê²Œ</span>
            </div>
          </button>
        </div>
      </div>
    );
  };

  // í–¥ íŠ¹ì„± ìŠ¬ë¼ì´ë” ì»´í¬ë„ŒíŠ¸
  const CharacteristicSlider = ({ 
    characteristic, 
    value, 
    onChange 
  }: { 
    characteristic: FragranceCharacteristic; 
    value: CharacteristicValue; 
    onChange: (char: FragranceCharacteristic, val: CharacteristicValue) => void;
  }) => {
    const sliderValue = characteristicToSliderValue(value);

    return (
      <div className="bg-white rounded-xl p-4 mb-4 shadow-sm border border-amber-100">
        <div className="flex items-center mb-3">
          <div className="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center mr-3">
            {characteristic === 'weight' && 'âš–ï¸'}
            {characteristic === 'sweetness' && 'ğŸ¯'}
            {characteristic === 'freshness' && 'â„ï¸'}
            {characteristic === 'uniqueness' && 'âœ¨'}
          </div>
          <div>
            <h3 className="font-medium text-gray-800">{CHARACTERISTIC_NAMES[characteristic]}ì„(ë¥¼) ì–´ë–»ê²Œ ê°œì„ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</h3>
            <p className="text-xs text-gray-500">
              {CHARACTERISTIC_DESCRIPTIONS[characteristic]}
            </p>
          </div>
        </div>

        <div className="mb-2">
          <div className="flex justify-between text-xs text-gray-500 mb-1">
            <span className="font-medium text-amber-600">
              {CHARACTERISTIC_LABELS[characteristic][value]}
            </span>
          </div>
          
          <input
            type="range"
            min="1"
            max="5"
            step="1"
            value={sliderValue}
            onChange={(e) => {
              const newValue = sliderToCharacteristicValue(parseInt(e.target.value));
              onChange(characteristic, newValue);
            }}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-amber-500"
          />
          
          <div className="flex justify-between mt-2">
            {[1, 2, 3, 4, 5].map((val) => (
              <button
                key={val}
                onClick={() => onChange(characteristic, sliderToCharacteristicValue(val))}
                className={`w-8 h-8 rounded-full flex items-center justify-center text-xs ${
                  sliderValue === val 
                    ? 'bg-amber-500 text-white' 
                    : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                }`}
              >
                {val}
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  };

  // ì¹´í…Œê³ ë¦¬ ì„ í˜¸ë„ ë³€ê²½ ì²˜ë¦¬
  const handleCategoryPreferenceChange = (category: PerfumeCategory, preference: CategoryPreference) => {
    setFeedback({
      ...feedback,
      categoryPreferences: {
        ...(feedback.categoryPreferences || {
          citrus: 'maintain',
          floral: 'maintain',
          woody: 'maintain',
          musky: 'maintain',
          fruity: 'maintain',
          spicy: 'maintain'
        }),
        [category]: preference,
      },
    });
  };

  // í–¥ íŠ¹ì„± ë³€ê²½ ì²˜ë¦¬
  const handleCharacteristicChange = (characteristic: FragranceCharacteristic, value: CharacteristicValue) => {
    setFeedback({
      ...feedback,
      userCharacteristics: {
        ...(feedback.userCharacteristics || {
          weight: 'medium',
          sweetness: 'medium',
          freshness: 'medium',
          uniqueness: 'medium'
        }),
        [characteristic]: value,
      },
    });
  };

  // í–¥ë£Œ ì¶”ê°€ ì²˜ë¦¬
  const handleAddScent = () => {
    if (selectedScent) {
      const updatedScents = [...(feedback.specificScents || [])];
      
      // ì´ë¯¸ ìˆëŠ” í–¥ë£Œì¸ì§€ í™•ì¸
      const existingIndex = updatedScents.findIndex(s => s.id === selectedScent.id);
      
      if (existingIndex >= 0) {
        // ì´ë¯¸ ìˆëŠ” í–¥ë£Œë©´ ì•Œë¦¼
        setError('ì´ë¯¸ ì„ íƒí•œ í–¥ë£Œì…ë‹ˆë‹¤.');
        setTimeout(() => setError(null), 3000); // 3ì´ˆ í›„ ì—ëŸ¬ ë©”ì‹œì§€ ì‚¬ë¼ì§
      } else {
        // ìƒˆ í–¥ë£Œ ì¶”ê°€ (ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ í—ˆìš©)
        if (updatedScents.length >= 2) {
          // ì´ë¯¸ 2ê°œê°€ ìˆìœ¼ë©´ ì•Œë¦¼ í‘œì‹œ í›„ ì¢…ë£Œ
          setError('í–¥ë£ŒëŠ” ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          setTimeout(() => setError(null), 3000); // 3ì´ˆ í›„ ì—ëŸ¬ ë©”ì‹œì§€ ì‚¬ë¼ì§
          setSelectedScent(null);
          return;
        }
        
        // SpecificScent í˜•ì‹ì— ë§ì¶”ê¸°
        updatedScents.push({
          id: selectedScent.id,
          name: selectedScent.name,
          ratio: 50, // ê¸°ë³¸ê°’ 50%
          action: 'add' // í•„ìˆ˜ ì†ì„±
        });
      }
      
      setFeedback({
        ...feedback,
        specificScents: updatedScents,
      });
      
      setSelectedScent(null);
    }
  };

  // í–¥ë£Œ ì œê±° ì²˜ë¦¬
  const handleRemoveScent = (id: string) => {
    if (feedback.specificScents) {
      setFeedback({
        ...feedback,
        specificScents: feedback.specificScents.filter(s => s.id !== id),
      });
    }
  };

  // ë‹¨ê³„ ì´ë™ ì²˜ë¦¬
  const handleNextStep = () => {
    setError(null);
    if (step < 3) {  // ë‹¨ê³„ ìˆ˜ 3ìœ¼ë¡œ ë³€ê²½
      setStep(step + 1);
    } else {
      handleSubmit();
    }
  };

  const handlePrevStep = () => {
    if (step > 1) {
      setStep(step - 1);
    } else {
      onClose();
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-amber-50 to-amber-100 bg-opacity-95">
      <div className="w-full max-w-md p-6 mx-4 bg-white rounded-2xl shadow-xl border border-amber-200 max-h-[90vh] overflow-y-auto">
        {/* í—¤ë” ì˜ì—­ */}
        <div className="flex justify-between items-center mb-6">
          <div className="flex items-center">
            <div className="w-10 h-10 rounded-full bg-gradient-to-r from-amber-400 to-amber-600 flex items-center justify-center mr-3 text-xl shadow-md">
              âœ¨
            </div>
            <div>
              <h2 className="text-xl font-bold bg-gradient-to-r from-amber-600 to-amber-800 bg-clip-text text-transparent">AC'SCENT ID</h2>
              <p className="text-xs text-amber-500">ë‹¹ì‹ ë§Œì˜ ë§ì¶¤ í–¥ìˆ˜</p>
            </div>
          </div>
          <button
            onClick={onClose}
            className="p-1.5 rounded-full hover:bg-gray-100 transition-all"
            disabled={loading}
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" className="w-6 h-6 text-gray-500">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* ì¶”ì²œëœ í–¥ìˆ˜ ì •ë³´ í‘œì‹œ */}
        <div className="mb-6 p-5 bg-gradient-to-r from-amber-50 to-amber-100 rounded-xl border border-amber-200 shadow-md">
          <div className="flex items-center">
            <div className="w-14 h-14 bg-gradient-to-r from-amber-400 to-amber-500 rounded-full flex items-center justify-center mr-4 shadow-md">
              <span className="text-2xl text-white">ğŸ§ª</span>
            </div>
            <div>
              <p className="text-sm text-amber-600 font-medium">ë§ì¶¤ í–¥ìˆ˜</p>
              <h3 className="text-lg font-medium text-gray-800">{perfumeName}</h3>
              <div className="flex items-center mt-1">
                <span className="text-xs py-0.5 px-2 bg-amber-100 text-amber-700 rounded-full font-medium">{formatScentCode(perfumeId)}</span>
              </div>
            </div>
          </div>
        </div>

        {/* ì§„í–‰ ìƒíƒœ í‘œì‹œ */}
        <div className="mb-6">
          <div className="flex justify-between mb-2 items-center">
            <div className="flex items-center">
              <span className="text-xs font-medium bg-gradient-to-r from-amber-500 to-amber-600 text-white py-1 px-2 rounded-full shadow-sm">ë‹¨ê³„ {step}/3</span>
            </div>
            <span className="text-xs font-medium text-amber-700 bg-amber-50 py-1 px-3 rounded-full shadow-sm border border-amber-100">
              {step === 1 ? 'í–¥ì˜ ìœ ì§€ ë¹„ìœ¨ ì„ íƒ' : step === 2 ? 'í–¥ì˜ íŠ¹ì„± ê°œì„ ' : 'ì„¸ë¶€ í–¥ë£Œ ì„ íƒ'}
            </span>
          </div>
          <div className="w-full h-2.5 bg-gray-200 rounded-full overflow-hidden shadow-inner">
            <div
              className="h-full bg-gradient-to-r from-amber-400 to-amber-600 rounded-full transition-all duration-500 ease-in-out"
              style={{ width: `${(step / 3) * 100}%` }}
            ></div>
          </div>
        </div>

        {/* ì˜¤ë¥˜ ë©”ì‹œì§€ */}
        {error && (
          <motion.div 
            initial={{ opacity: 0, y: -10 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -10 }}
            className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg shadow-sm flex items-start"
          >
            <div className="shrink-0 w-5 h-5 rounded-full bg-red-500 flex items-center justify-center mr-2 mt-0.5">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="white" className="w-4 h-4">
                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
          </svg>
        </div>
        <p className="text-red-600 text-sm">{error}</p>
      </motion.div>
    )}

    {/* ì„±ê³µ ë©”ì‹œì§€ & ì»¤ìŠ¤í„°ë§ˆì´ì œì´ì…˜ ê²°ê³¼ */}
    {success ? (
      <div className="py-4 flex flex-col">
        <motion.div 
          initial={{ scale: 0 }}
          animate={{ scale: 1 }}
          transition={{ duration: 0.5 }}
          className="w-16 h-16 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mb-4 mx-auto shadow-lg"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white" className="w-8 h-8">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
        </motion.div>
        
        <h3 className="text-center text-lg font-medium text-gray-800 mb-2">
          ë§ì¶¤ í–¥ìˆ˜ ë ˆì‹œí”¼ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!
        </h3>
        
        {customizationLoading ? (
          <div className="flex flex-col items-center justify-center py-8">
            <div className="w-12 h-12 border-4 border-t-transparent border-amber-500 rounded-full animate-spin mb-4"></div>
            <p className="text-amber-600 font-medium">ë§ì¶¤ í–¥ìˆ˜ ë ˆì‹œí”¼ ìƒì„± ì¤‘...</p>
            <p className="text-sm text-gray-500 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ìµœëŒ€ 15ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.</p>
          </div>
        ) : recipe ? (
          <div className="mt-4 space-y-6">
            {/* í”¼ë“œë°± ë°˜ì˜ ì‹œê°í™” - Before & After */}
            <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-5 border border-indigo-200 shadow-md">
              <h4 className="font-semibold text-indigo-800 mb-3 flex items-center">
                <span className="text-lg mr-2">âœ¨</span> í”¼ë“œë°±ì´ ë°˜ì˜ëœ ê²°ê³¼
              </h4>
              
              {/* ìœ ì§€ ë¹„ìœ¨ ì‹œê°í™” */}
              <div className="mb-4">
                <div className="flex justify-between items-center mb-2">
                  <p className="text-sm font-medium text-gray-700">ê¸°ì¡´ í–¥ ìœ ì§€ ë¹„ìœ¨</p>
                  <p className="text-sm font-medium text-indigo-600">{feedback.retentionPercentage}%</p>
                </div>
                <div className="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                  <div 
                    className="h-full bg-gradient-to-r from-indigo-400 to-purple-500 rounded-full"
                    style={{ width: `${feedback.retentionPercentage}%` }}
                  ></div>
                </div>
              </div>
              
              {/* í–¥ íŠ¹ì„± Before & After */}
              <div className="bg-white rounded-lg p-4 mb-4 shadow-sm">
                <p className="text-sm font-medium text-gray-700 mb-2">í–¥ íŠ¹ì„± ë³€í™”</p>
                
                <div className="aspect-square w-full max-w-md mx-auto">
                  {/* ë ˆì´ë” ì°¨íŠ¸ */}
                  <Radar 
                    data={{
                      labels: Object.keys(CHARACTERISTIC_NAMES).map(key => CHARACTERISTIC_NAMES[key as FragranceCharacteristic]),
                      datasets: [
                        {
                          label: 'ë³€ê²½ ì „',
                          data: Object.keys(CHARACTERISTIC_NAMES).map(() => 3), // ê¸°ë³¸ê°’ ì¤‘ê°„(3)
                          backgroundColor: 'rgba(255, 99, 132, 0.2)',
                          borderColor: 'rgba(255, 99, 132, 1)',
                          borderWidth: 1,
                        },
                        {
                          label: 'ë³€ê²½ í›„',
                          data: Object.keys(CHARACTERISTIC_NAMES).map(key => 
                            characteristicToSliderValue(feedback.userCharacteristics?.[key as FragranceCharacteristic] || 'medium')
                          ),
                          backgroundColor: 'rgba(54, 162, 235, 0.2)',
                          borderColor: 'rgba(54, 162, 235, 1)',
                          borderWidth: 1,
                        }
                      ]
                    }}
                    options={{
                      scales: {
                        r: {
                          min: 0,
                          max: 5,
                          ticks: {
                            stepSize: 1,
                            display: false
                          }
                        }
                      }
                    }}
                  />
                </div>
              </div>
              
              {/* ì„ íƒí•œ íŠ¹ì„± ëª©ë¡ */}
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-2">
                {Object.entries(feedback.userCharacteristics || {}).map(([char, value]) => (
                  <div key={char} className="bg-white rounded-lg p-3 border border-purple-100 flex items-center">
                    <div className="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-100 to-purple-100 flex items-center justify-center mr-2">
                      {char === 'weight' && 'âš–ï¸'}
                      {char === 'sweetness' && 'ğŸ¯'}
                      {char === 'freshness' && 'â„ï¸'}
                      {char === 'uniqueness' && 'âœ¨'}
                    </div>
                    <div>
                      <p className="text-xs text-gray-500">{CHARACTERISTIC_NAMES[char as FragranceCharacteristic]}</p>
                      <p className="text-sm font-medium text-indigo-600">
                        {CHARACTERISTIC_LABELS[char as FragranceCharacteristic][value]}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* ë ˆì‹œí”¼ ì‹œê°í™” - ë„ë„› ì°¨íŠ¸ */}
            <div className="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-5 border border-blue-200 shadow-md">
              <h4 className="font-semibold text-blue-800 mb-3 flex items-center">
                <span className="text-lg mr-2">ğŸ“Š</span> ë ˆì‹œí”¼ êµ¬ì„± ë¹„ìœ¨
              </h4>
              
              <div className="flex flex-col md:flex-row items-center justify-between">
                <div className="w-full md:w-1/2 aspect-square max-w-[250px] mx-auto">
                  <Doughnut 
                    data={{
                      labels: recipe.recipe['10ml'].map(c => formatScentCode(c.name)),
                      datasets: [{
                        data: recipe.recipe['10ml'].map(c => c.percentage),
                        backgroundColor: [
                          'rgba(255, 99, 132, 0.7)',
                          'rgba(54, 162, 235, 0.7)',
                          'rgba(255, 206, 86, 0.7)',
                          'rgba(75, 192, 192, 0.7)',
                          'rgba(153, 102, 255, 0.7)',
                        ],
                        borderColor: [
                          'rgba(255, 99, 132, 1)',
                          'rgba(54, 162, 235, 1)',
                          'rgba(255, 206, 86, 1)',
                          'rgba(75, 192, 192, 1)',
                          'rgba(153, 102, 255, 1)',
                        ],
                        borderWidth: 1,
                      }]
                    }}
                    options={{
                      plugins: {
                        legend: {
                          display: false
                        }
                      }
                    }}
                  />
                </div>
                
                <div className="mt-4 md:mt-0 md:ml-4 w-full md:w-1/2">
                  <div className="grid grid-cols-1 gap-2">
                    {recipe.recipe['10ml'].map((component, i) => (
                      <div key={i} className="flex items-center p-2 bg-white rounded-lg border border-blue-100">
                        <div className="w-3 h-3 rounded-full mr-2" style={{ 
                          backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                          ][i % 5]
                        }}></div>
                        <div className="flex-1">
                          <div className="flex justify-between">
                            <span className="text-xs font-semibold text-gray-700">{formatScentCode(component.name)}</span>
                            <span className="text-xs font-medium text-blue-600">{component.percentage}%</span>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
            
            {/* í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ */}
            <div className="bg-gradient-to-r from-amber-50 to-yellow-50 rounded-xl p-5 border border-amber-200 shadow-md">
              <h4 className="font-semibold text-amber-800 mb-3 flex items-center">
                <span className="text-lg mr-2">ğŸ§ª</span> í–¥ë£Œ ì•Œê°±ì´ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ
              </h4>
              
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                {recipe.testGuide.scentMixtures.map((scent, i) => (
                  <motion.div 
                    key={i} 
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: i * 0.1 }}
                    className="flex items-center bg-white rounded-lg p-3 border border-amber-100 shadow-sm hover:shadow-md transition-shadow"
                  >
                    <div className="w-10 h-10 rounded-full bg-gradient-to-r from-amber-400 to-yellow-400 flex items-center justify-center mr-3 shrink-0 shadow-sm text-white font-semibold">
                      {i + 1}
                    </div>
                    <div>
                      <p className="text-sm font-medium text-gray-800">{formatScentCode(scent.name)}</p>
                      <div className="flex items-center mt-1">
                        <div className="w-full bg-gray-200 rounded-full h-1.5">
                          <div 
                            className="bg-gradient-to-r from-amber-400 to-yellow-400 h-1.5 rounded-full" 
                            style={{ width: `${scent.ratio}%` }}
                          ></div>
                        </div>
                        <span className="text-xs ml-2 text-amber-600 font-medium">{scent.ratio}%</span>
                      </div>
                    </div>
                  </motion.div>
                ))}
              </div>
              
              <div className="mt-4 bg-white p-4 rounded-lg border border-amber-100 shadow-sm">
                <p className="font-medium text-gray-700 mb-2 flex items-center">
                  <span className="text-amber-500 mr-2">ğŸ“‹</span>
                  í…ŒìŠ¤íŠ¸ ë°©ë²•
                </p>
                <p className="text-gray-600 text-sm">{recipe.testGuide.instructions}</p>
              </div>
            </div>
            
            {/* ë ˆì‹œí”¼ í…Œì´ë¸” */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {/* 10ml ë ˆì‹œí”¼ */}
              <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-5 border border-blue-200 shadow-md">
                <h4 className="font-semibold text-blue-800 mb-3 flex items-center">
                  <span className="text-lg mr-2">ğŸ’§</span> 10ml ë ˆì‹œí”¼
                </h4>
                
                <div className="overflow-hidden rounded-lg shadow-sm">
                  <table className="w-full text-sm">
                    <thead className="bg-blue-500 text-white">
                      <tr>
                        <th className="p-2 text-left rounded-tl-lg">í–¥ë£Œ ì½”ë“œ</th>
                        <th className="p-2 text-right">ì–‘</th>
                        <th className="p-2 text-right rounded-tr-lg">ë¹„ìœ¨</th>
                      </tr>
                    </thead>
                    <tbody>
                      {recipe.recipe['10ml'].map((component, i) => (
                        <tr key={i} className={i % 2 === 0 ? 'bg-white' : 'bg-blue-50'}>
                          <td className="p-2 font-medium">{formatScentCode(component.name)}</td>
                          <td className="p-2 text-right">{component.amount}</td>
                          <td className="p-2 text-right font-medium text-blue-600">{component.percentage}%</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
              
              {/* 50ml ë ˆì‹œí”¼ */}
              <div className="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-5 border border-purple-200 shadow-md">
                <h4 className="font-semibold text-purple-800 mb-3 flex items-center">
                  <span className="text-lg mr-2">ğŸ§´</span> 50ml ë ˆì‹œí”¼
                </h4>
                
                <div className="overflow-hidden rounded-lg shadow-sm">
                  <table className="w-full text-sm">
                    <thead className="bg-purple-500 text-white">
                      <tr>
                        <th className="p-2 text-left rounded-tl-lg">í–¥ë£Œ ì½”ë“œ</th>
                        <th className="p-2 text-right">ì–‘</th>
                        <th className="p-2 text-right rounded-tr-lg">ë¹„ìœ¨</th>
                      </tr>
                    </thead>
                    <tbody>
                      {recipe.recipe['50ml'].map((component, i) => (
                        <tr key={i} className={i % 2 === 0 ? 'bg-white' : 'bg-purple-50'}>
                          <td className="p-2 font-medium">{formatScentCode(component.name)}</td>
                          <td className="p-2 text-right">{component.amount}</td>
                          <td className="p-2 text-right font-medium text-purple-600">{component.percentage}%</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            {/* ì„¤ëª… */}
            <div className="bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl p-5 border border-gray-200 shadow-md">
              <h4 className="font-semibold text-gray-800 mb-3 flex items-center">
                <span className="text-lg mr-2">ğŸ’«</span> ì¡°í–¥ì‚¬ì˜ ì„¤ëª…
              </h4>
              
              <div className="space-y-4 mt-2 text-sm">
                <div className="bg-white p-4 rounded-lg border border-gray-100 shadow-sm">
                  <p className="font-medium text-gray-700 mb-1">ë°°í•© ì´ìœ </p>
                  <p className="text-gray-600">{recipe.explanation.rationale}</p>
                </div>
                
                <div className="bg-white p-4 rounded-lg border border-gray-100 shadow-sm">
                  <p className="font-medium text-gray-700 mb-1">ì˜ˆìƒë˜ëŠ” í–¥ì˜ íŠ¹ì§•</p>
                  <p className="text-gray-600">{recipe.explanation.expectedResult}</p>
                </div>
                
                <div className="bg-white p-4 rounded-lg border border-gray-100 shadow-sm">
                  <p className="font-medium text-gray-700 mb-1">ì¶”ì²œ ìƒí™©</p>
                  <p className="text-gray-600">{recipe.explanation.recommendation}</p>
                </div>
              </div>
            </div>
            
            <div className="flex justify-center mt-4">
              <button
                onClick={onClose}
                className="px-6 py-2.5 bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-lg hover:from-amber-600 hover:to-amber-700 focus:ring-2 focus:ring-amber-300 focus:outline-none transition-all shadow-md hover:shadow-lg"
              >
                í™•ì¸ ì™„ë£Œ
              </button>
            </div>
          </div>
                  ) : (
          <div className="text-center py-4">
            <p className="text-gray-500">
              í”¼ë“œë°±ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!
            </p>
            <p className="text-sm text-gray-400 mt-2">
              ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤. í–¥ìˆ˜ ì¶”ì²œ í’ˆì§ˆ í–¥ìƒì— í° ë„ì›€ì´ ë©ë‹ˆë‹¤.
            </p>
            <button
              onClick={onClose}
              className="mt-4 px-4 py-2 bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-lg hover:from-amber-600 hover:to-amber-700 transition-colors shadow-md"
            >
              ë‹«ê¸°
            </button>
          </div>
        )}
      </div>
    </div>
  );
}